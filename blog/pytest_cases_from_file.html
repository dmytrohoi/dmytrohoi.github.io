
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="/theme/pygments/github.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <script defer src="https://use.fontawesome.com/releases/v5.5.0/js/all.js" integrity="sha384-GqVMZRt5Gn7tB9D9q7ONtcp4gtHIUEW/yG7h98J7IpE3kpi+srfFyyB/04OV6pG0" crossorigin="anonymous"></script>


    <link href="https://dmytrohoi.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Dmytro Hoi Atom">

    <link href="https://dmytrohoi.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Dmytro Hoi RSS">

    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-129013894-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

<meta name="author" content="Dmytro Hoi" />
<meta name="description" content="Копия статьи опубликованной на сайте habr.com В области автоматического тестирования можно встретить разные инструменты, так, для написания авто-тестов на языке Python одним из наиболее популярных решений на данный момент является py.test. Прошерстив множество ресурсов связанных с pytest и изучив документацию с официального сайта проекта я не смог найти прямое описание решения одной из основных задач - запуск тестов с тестовыми данными, хранящимися в отдельном файле. Иначе, можно сказать, подгрузки параметров в тестовые функции из файла(-ов) или параметризация из файла напрямую. Такая процедура в тонкостях нигде не описана и единственные упоминание данной возможности есть лишь в одной строке документации pytest.В этой статье я расскажу о своем решении этой задачи." />
<meta name="keywords" content="blog, python, qa, lang:russian">

<meta property="og:site_name" content="Dmytro Hoi"/>
<meta property="og:title" content="Параметризация из файла в py.test"/>
<meta property="og:description" content="Копия статьи опубликованной на сайте habr.com В области автоматического тестирования можно встретить разные инструменты, так, для написания авто-тестов на языке Python одним из наиболее популярных решений на данный момент является py.test. Прошерстив множество ресурсов связанных с pytest и изучив документацию с официального сайта проекта я не смог найти прямое описание решения одной из основных задач - запуск тестов с тестовыми данными, хранящимися в отдельном файле. Иначе, можно сказать, подгрузки параметров в тестовые функции из файла(-ов) или параметризация из файла напрямую. Такая процедура в тонкостях нигде не описана и единственные упоминание данной возможности есть лишь в одной строке документации pytest.В этой статье я расскажу о своем решении этой задачи."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://dmytrohoi.com/blog/pytest_cases_from_file"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-10-23 10:30:00+03:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://dmytrohoi.com/author/dmytro-hoi.html">
<meta property="article:section" content="blog"/>
<meta property="article:tag" content="blog"/>
<meta property="article:tag" content="python"/>
<meta property="article:tag" content="qa"/>
<meta property="article:tag" content="lang:russian"/>
<meta property="og:image" content="/images/site_profile_nov19.png">

  <title>Dmytro Hoi &ndash; Параметризация из файла в py.test</title>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
      google_ad_client: "ca-pub-3596869803955189",
      enable_page_level_ads: true
    });
  </script>
<!-- Google Tag Manager -->
<script>
  (function(w,d,s,l,i){
    w[l]=w[l]||[];
    w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
    var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
    j.async=true;
    j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
    f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-TSH38JV');
</script>
<!-- End Google Tag Manager -->  <script src="https://code.iconify.design/1/1.0.3/iconify.min.js"></script>
</head>
<body>
<!-- Google Tag Manager -->
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TSH38JV" height="0" width="0" style="display:none;visibility:hidden"></iframe>
</noscript>
<!-- End Google Tag Manager -->  <aside>
    <div>
      <a href="https://dmytrohoi.com">
        <img src="/images/site_profile_nov19.png" alt="Dmytro Hoi" title="Dmytro Hoi">
      </a>
      <h1><a href="https://dmytrohoi.com">Dmytro Hoi</a></h1>

<p>Python Developer and Blogger</p>
      <nav>
        <ul class="list">

          <li><a href="/blog" >Blog</a></li>
          <li><a href="/books" >Books</a></li>
          <li><a href="/projects" >Projects</a></li>
          <li><a href="/progsrc" >progSrc</a></li>
          <li><a href="/about" >About</a></li>
          <li><a href="/blog/cv" >CV</a></li>
        </ul>
      </nav>

      <ul class="social">
        <li><a  href="http://fb.com/dmytro.hoi" target="_blank"><i class="fab fa-facebook"></i></a></li>
        <li><a  href="http://t.me/dmytrohoi" target="_blank"><i class="fab fa-telegram"></i></a></li>
        <li><a  href="http://linkedin.com/in/dmytrohoi" target="_blank"><i class="fab fa-linkedin"></i></a></li>
        <li><a  href="http://twitter.com/dmytrohoi" target="_blank"><i class="fab fa-twitter-square"></i></a></li>
        <li><a  href="/progsrc" target="_blank"><i class="fas fa-pen-square"></i></a></li>
        <li><a  href="http://dev.to/dmytrohoi" target="_blank"><i class="fab fa-dev"></i></a></li>
        <li><a  href="/send_money" target="_blank"><i class="fas fa-hryvnia"></i></a></li>
        <li><a  href="http://github.com/dmytrohoi" target="_blank"><i class="fab fa-github-square"></i></a></li>
        <li><a  href="http://habr.com/users/dmytrohoi" target="_blank"><i class="fas fa-h-square"></i></a></li>
        <li><a  href="https://pypi.org/user/dmytrohoi/" target="_blank"><i class="iconify icon:simple-icons:pypi icon-inline:false"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://dmytrohoi.com">    Home
</a>

      <a href="/archives">Archives</a>
      <a href="/categories">Categories</a>
      <a href="/tags">Tags</a>

      <a href="https://dmytrohoi.com/feeds/all.atom.xml">    Atom
</a>

      <a href="https://dmytrohoi.com/feeds/all.rss.xml">    RSS
</a>
    </nav>

<article class="single">
  <header>
      
    <h1 id="pytest_cases_from_file">Параметризация из файла в py.test</h1>
    <p>
          Posted on October 23, 2019 in <a href="https://dmytrohoi.com/blog">blog</a>


        &#8226; 5 min read
    </p>
  </header>


  <div>
    <p><a href="https://habr.com/ru/post/472766/"><em>Оригинал статьи на сайте habr.com</em></a></p>
<p>В области автоматического тестирования можно встретить разные инструменты, так, для написания авто-тестов на языке Python одним из наиболее популярных решений на данный момент является py.test.</p>
<p>Прошерстив множество ресурсов связанных с pytest и изучив документацию с официального сайта проекта я не смог найти прямое описание решения одной из основных задач - запуск тестов с тестовыми данными, хранящимися в отдельном файле. Иначе, можно сказать, подгрузки параметров в тестовые функции из файла(-ов) или параметризация из файла напрямую. Такая процедура в тонкостях нигде не описана и единственные упоминание данной возможности есть лишь в одной строке документации pytest.</p>
<p>В этой статье я расскажу о своем решении этой задачи.
<cut /></p>
<hr>
<h2>Задача</h2>
<p>Основная задача - генерация тестовых случаев в виде параметров <code>test_input</code> и <code>expected_result</code> в каждую отдельную тестовую функцию из соответствующих названию функций файлов.</p>
<p><em>Дополнительные задачи:</em>
- <em>выбрать человекочитаемое форматирование файлов с тест-кейсами;</em>
- <em>оставить возможность поддержки захардкоженых тест-кейсов;</em>
- <em>выводить понятные идентификаторы для каждого кейса.</em></p>
<h2>Инструментарий</h2>
<p>В статье я задействую Python 3 (подойдёт и 2.7), pyyaml, и <code>pytest</code> (версии 5+ для Python 3, или 4.6 для Python 2.7) без использования сторонних плагинов. Кроме того будет использована стандартная библиотека <code>os</code></p>
<p>Сам файл из которого мы будем брать тест-кейсы необходимо структурировать используя удобный для понимания человеку язык разметки. В моем случае был выбран YAML <em>(т.к. он решает доп. задача по выбору человекочитаемого формата)</em>. По факту какой именно вам нужен язык разметки файлов с дата-сетами - зависит только от представленных на проекте требований.</p>
<hr>
<h2>Реализация</h2>
<p>Так как основным столпом мироздания в программировании является соглашение, нам придется ввести несколько оных и для нашего решения.</p>
<h4>Перехват</h4>
<p>Начнем с того, что в данном решении используется функция перехвата <code>pytest_generate_tests</code> (<a href="https://docs.pytest.org/en/latest/parametrize.html#basic-pytest-generate-tests-example">wiki</a>), которая запускается на этапе генерации тест кейсов, и ее аргумент <code>metafunc</code>, который позволяет нам параметризировать функцию. В этом месте pytest перебирает каждую тестовую функцию и для нее выполняет последующий код генерации.</p>
<h4>Аргументы</h4>
<p>Необходимо определить исчерпывающий список параметров для тестовых функций. В моем случае словарь <code>test_input</code> и любой тип данных <em>(чаще всего строка или целое число)</em> в <code>expected_result</code>. Эти параметры необходимы нам для использования в <code>metafunc.parametrize(...)</code>.</p>
<h4>Параметризация</h4>
<p>Данная функция полностью повторяет работу <a href="https://docs.pytest.org/en/latest/parametrize.html#pytest-mark-parametrize-parametrizing-test-functions">фикстуры параметризации</a> <code>@pytest.mark.parametrize</code>, которая первым аргументом принимает строку с перечислением аргументов тестовой функции (в нашем случае <code>"test_input, expected_result"</code>) и список данных по которому она будет итерируясь создавать наши тестовые кейсы (например, <code>[(1, 2), (2, 4), (3, 6)]</code>).</p>
<p>В бою это будет выглядеть так:</p>
<div class="highlight"><pre><span></span><span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s2">&quot;test_input, expected_result&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">(</span><span class="n">test_input</span><span class="p">,</span> <span class="n">expected_result</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">test_input</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">expected_result</span>
</pre></div>


<p>А в нашем случае, мы заранее укажем это:</p>
<div class="highlight"><pre><span></span><span class="c1"># Наша реализация...</span>
<span class="k">return</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;test_input, expected&quot;</span><span class="p">,</span> <span class="n">test_cases</span><span class="p">)</span> <span class="c1"># или `[(1, 2), (2, 4), (3, 6)]`</span>
</pre></div>


<h4>Фильтрация</h4>
<p>Отсюда также следует выделение тех тестовых функций, где необходима подгрузка данных из файла, от тех которые используют статичные/динамичные данные. Эту фильтрацию мы будем применять до начала парсинга информации из файла.</p>
<p>Сами фильтры могут быть любыми, например:</p>
<ul>
<li>Маркер функции с именем <code>yaml</code>:</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># Откидываем варианты вообще без каких-либо маркеров</span>
<span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">metafunc</span><span class="o">.</span><span class="n">function</span><span class="p">,</span> <span class="s1">&#39;pytestmark&#39;</span><span class="p">):</span>
    <span class="k">return</span>

<span class="c1"># Берем все маркеры нынешней функции и их имена вносим в список</span>
<span class="n">mark_names</span> <span class="o">=</span> <span class="p">[</span> <span class="n">mark</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">mark</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">pytestmark</span> <span class="p">]</span>
<span class="c1"># Пропускаем эту функцию, если в списке нет выбранного нами маркера</span>
<span class="k">if</span> <span class="s1">&#39;yaml&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mark_names</span><span class="p">:</span>
    <span class="k">return</span>
</pre></div>


<p>Иначе тот же фильтр можно реализовать так:</p>
<div class="highlight"><pre><span></span><span class="c1"># Создаем пустой маркер и ищем такой же в маркерах функции</span>
<span class="k">if</span> <span class="n">Mark</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="err">’</span><span class="n">yaml</span><span class="err">’</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{})</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">pytestmark</span><span class="p">:</span>
    <span class="k">return</span>
</pre></div>


<ul>
<li>Аргумент функции <code>test_input</code>:</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># Пропускаем все функции, у которых нет аргумента test_input</span>
<span class="k">if</span> <span class="s1">&#39;test_input&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
        <span class="k">return</span>
</pre></div>


<p>Мне больше всего подошел этот вариант.</p>
<hr>
<h2>Результат</h2>
<p>Нам надо дописать лишь часть, где мы парсим данные из файла. Это не составит труда в случае с yaml <em>(а также json, xml и т.д.)</em>, поэтому собираем все до кучи.</p>
<div class="highlight"><pre><span></span><span class="c1"># conftest.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">):</span>

    <span class="c1"># Пропускаем все функции, у которых нет аргумента test_input</span>
    <span class="k">if</span> <span class="s1">&#39;test_input&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Определяем директорию текущего файла</span>
    <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">metafunc</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>

    <span class="c1"># Определяем путь к файлу с данными</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">)</span>
    <span class="c1"># Открываем выбранный файл</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">test_cases</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">full_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Предусматриваем неправильную загрузку и пустой файл</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">test_cases</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test cases not loaded&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;test_input, expected_result&quot;</span><span class="p">,</span> <span class="n">test_cases</span><span class="p">)</span>
</pre></div>


<p>Тестовый скрипт пишем примерно таким:</p>
<div class="highlight"><pre><span></span><span class="c1"># test_script.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">def</span> <span class="nf">test_multiplication</span><span class="p">(</span><span class="n">test_input</span><span class="p">,</span> <span class="n">expected_result</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">test_input</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">expected_result</span>
</pre></div>


<p>А файл с данными:</p>
<div class="highlight"><pre><span></span><span class="c1"># test_multiplication.yaml</span>
  <span class="p p-Indicator">-</span> <span class="kt">!!python/tuple</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nv">2</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="kt">!!python/tuple</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nv">3</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="kt">!!python/tuple</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nv">5</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="kt">!!python/tuple</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nv">4</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="kt">!!python/tuple</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="nv">4</span><span class="p p-Indicator">]</span>
  <span class="p p-Indicator">-</span> <span class="kt">!!python/tuple</span> <span class="p p-Indicator">[</span><span class="nv">5</span><span class="p p-Indicator">,</span><span class="nv">4</span><span class="p p-Indicator">]</span>
</pre></div>


<p>Мы получаем такой список тест-кейсов:</p>
<div class="highlight"><pre><span></span> pytest /test_script.py --collect-only
<span class="o">========================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">========================</span>
platform linux -- Python <span class="m">3</span>.7.4, pytest-5.2.1, py-1.8.0, pluggy-0.13.0
rootdir: /pytest_habr
collected <span class="m">6</span> items
&lt;Module test_script.py&gt;
  &lt;Function test_multiplication<span class="o">[</span><span class="m">1</span>-2<span class="o">]</span>&gt;
  &lt;Function test_multiplication<span class="o">[</span><span class="m">1</span>-3<span class="o">]</span>&gt;
  &lt;Function test_multiplication<span class="o">[</span><span class="m">1</span>-5<span class="o">]</span>&gt;
  &lt;Function test_multiplication<span class="o">[</span><span class="m">2</span>-4<span class="o">]</span>&gt;
  &lt;Function test_multiplication<span class="o">[</span><span class="m">3</span>-4<span class="o">]</span>&gt;
  &lt;Function test_multiplication<span class="o">[</span><span class="m">5</span>-4<span class="o">]</span>&gt;

<span class="o">========================</span> no tests ran in <span class="m">0</span>.04s <span class="o">========================</span>
</pre></div>


<p>А запустив скрипт, такой результат: <code>4 failed, 2 passed, 1 warnings in 0.11s</code></p>
<hr>
<h2>Доп. задания</h2>
<p>На этом можно было бы закончить статью, но для пущей сложности я добавлю в нашу функцию более удобные идентификаторы, другой парсинг данных и маркировку каждого отдельного тестового случая.</p>
<p>Итак, сразу с ходу код:</p>
<div class="highlight"><pre><span></span><span class="c1"># conftest.py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">generate_id</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">level</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Выбираем как это будет выглядеть</span>
        <span class="n">INDENTS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># level: (levelmark, addition_indent)</span>
            <span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]),</span>
            <span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="n">COMMON_INDENT</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">])</span>

        <span class="n">levelmark</span><span class="p">,</span> <span class="n">additional_indent</span> <span class="o">=</span> <span class="n">INDENTS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">COMMON_INDENT</span><span class="p">)</span>

        <span class="c1"># Если глубже второго уровня - идентификатором становится тип данных</span>
        <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">additional_indent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="n">additional_indent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Возвращаем простые данные</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>

        <span class="c1"># Разбираем список</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="c1"># Погружаемся в список, чтобы проверить те данные, что внутри</span>
            <span class="n">list_repr</span> <span class="o">=</span> <span class="n">levelmark</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span> <span class="n">generate_id</span><span class="p">(</span><span class="n">input_value</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">level</span><span class="p">)</span> \
                                        <span class="k">for</span> <span class="n">input_value</span> <span class="ow">in</span> <span class="n">input_data</span> <span class="p">])</span>
            <span class="k">return</span> <span class="n">additional_indent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">list_repr</span> <span class="o">+</span> <span class="n">additional_indent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Ключи словаря переводим в строку</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;{&#39;</span> <span class="o">+</span> <span class="n">levelmark</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">input_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span>

        <span class="c1"># Или ничего для ничего</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="c1"># Пропускаем все функции, у которых нет аргумента test_input</span>
    <span class="k">if</span> <span class="s1">&#39;test_input&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Определяем директорию текущего файла</span>
    <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">metafunc</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>

    <span class="c1"># Определяем путь к файлу с данными</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">)</span>
    <span class="c1"># Открываем выбранный файл</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">raw_test_cases</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">full_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># Предусматриваем неправильную загрузку и пустой файл</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_test_cases</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Test cases not loaded&quot;</span><span class="p">)</span>

    <span class="c1"># Тут будут наши тест-кейсы</span>
    <span class="n">test_cases</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Проходим по нашим сырым данным</span>
    <span class="k">for</span> <span class="n">case_id</span><span class="p">,</span> <span class="n">test_case</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">raw_test_cases</span><span class="p">):</span>
        <span class="c1"># Ищем список маркеров</span>
        <span class="n">marks</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pytest</span><span class="o">.</span><span class="n">mark</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">test_case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;marks&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="p">]</span>

        <span class="c1"># Берем идентификатор из данных, либо сгенерируем</span>
        <span class="n">case_id</span> <span class="o">=</span> <span class="n">test_case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">generate_id</span><span class="p">(</span><span class="n">test_case</span><span class="p">[</span><span class="s2">&quot;test_data&quot;</span><span class="p">],</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Добавляем в наш список сгенерированный из тестовых данных pytest.param</span>
        <span class="n">test_cases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pytest</span><span class="o">.</span><span class="n">param</span><span class="p">(</span><span class="o">*</span><span class="n">test_case</span><span class="p">[</span><span class="s2">&quot;test_data&quot;</span><span class="p">],</span> <span class="n">marks</span><span class="o">=</span><span class="n">marks</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">case_id</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;test_input, expected_result&quot;</span><span class="p">,</span> <span class="n">test_cases</span><span class="p">)</span>
</pre></div>


<p>Соответственно меняем то, как будет выглядеть наш YAML файл:</p>
<div class="highlight"><pre><span></span><span class="c1"># test_multiplication.yaml</span>
<span class="p p-Indicator">-</span>
  <span class="l l-Scalar l-Scalar-Plain">test_data</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span> <span class="nv">2</span><span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="s">&#39;one_two&#39;</span>
<span class="p p-Indicator">-</span>
  <span class="l l-Scalar l-Scalar-Plain">test_data</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nv">3</span><span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">marks</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;xfail&#39;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span>
  <span class="l l-Scalar l-Scalar-Plain">test_data</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">1</span><span class="p p-Indicator">,</span><span class="nv">5</span><span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">marks</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;skip&#39;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span>
  <span class="l l-Scalar l-Scalar-Plain">test_data</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="nv">4</span><span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">id</span><span class="p p-Indicator">:</span> <span class="s">&quot;it&#39;s</span><span class="nv"> </span><span class="s">good&quot;</span>
  <span class="l l-Scalar l-Scalar-Plain">marks</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;xfail&#39;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span>
  <span class="l l-Scalar l-Scalar-Plain">test_data</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="nv">4</span><span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">marks</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;negative&#39;</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span>
  <span class="l l-Scalar l-Scalar-Plain">test_data</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">5</span><span class="p p-Indicator">,</span><span class="nv">4</span><span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">marks</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&#39;more_than&#39;</span><span class="p p-Indicator">]</span>
</pre></div>


<p>Тогда описание поменяется на:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">&lt;Module test_script.py&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">&lt;Function test_multiplication[one_two]&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">&lt;Function test_multiplication[1_3]&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">&lt;Function test_multiplication[1_5]&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">&lt;Function test_multiplication[it&#39;s good]&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">&lt;Function test_multiplication[3_4]&gt;</span>
  <span class="l l-Scalar l-Scalar-Plain">&lt;Function test_multiplication[5_4]&gt;</span>
</pre></div>


<p>А запуск будет: <code>2 failed, 1 passed, 1 skipped, 1 xfailed, 1 xpassed, 2 warnings in 0.12s</code></p>
<p><em>P.S.: warnings - т.к. самописные маркеры не записаны в pytest.ini</em></p>
<h2>В развитие темы</h2>
<p>Готов обсудить в комментариях вопросы по типу:</p>
<ul>
<li>как лучше писать YAML файл?</li>
<li>в каком формате удобнее хранить тестовые данные?</li>
<li>что дополнительно необходимо тест-кейсу на стадии генерации?</li>
<li>нужны ли идентификаторы каждому кейсу?</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://dmytrohoi.com/tag/blog.html">blog</a>
      <a href="https://dmytrohoi.com/tag/python.html">python</a>
      <a href="https://dmytrohoi.com/tag/qa.html">qa</a>
      <a href="https://dmytrohoi.com/tag/langrussian.html">lang:russian</a>
    </p>
  </div>

  <div class="center social-share">
    <p>    
</p>
    <div class="addthis_native_toolbox"></div>
    <div class="addthis_sharing_toolbox"></div>
    <div class="addthis_inline_share_toolbox"></div>
  </div>


    <div class="addthis_relatedposts_inline"></div>


<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'hoi-pp';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy;  2020</p>
<p>    <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>


    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5be372bf4e2a102c" async="async"></script>


<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": "Dmytro Hoi",
  "url" : "https://dmytrohoi.com",
  "image": "/images/site_profile_nov19.png",
  "description": "On this site you find my articles, links to social networks and CV. 
Nice to meet you here!"
}
</script>

</body>
</html>